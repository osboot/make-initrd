# SPDX-License-Identifier: GPL-3.0-or-later

-include $(GUESSDIR)/guessed.mk

# The previous call to 'guess' has already done this.
IGNORE_DEPMOD := 1

PHONY += create pack install genimage

create: depmod-host
	@$(VMSG) "Creating initrd image ..."
	@mkdir -m 755 -p $(verbose) -- $(ROOTDIR)
	@$(TOOLSDIR)/create-initrd

pack: create
	@$(VMSG) "Sorting sysvinit services ..."
	@$(TOOLSDIR)/sort-services --rcdir="$(ROOTDIR)/etc/rc.d" "$(ROOTDIR)/etc/rc.d/init.d"
	@$(VMSG) "Packing image to archive ..."
	@$(TOOLSDIR)/pack-image

install: pack
	@$(VMSG) "Installing image ..."
	@if [ -f "$(TEMPDIR)/images" ] && grep -Fxqs "$(IMAGEFILE)" "$(TEMPDIR)/images"; then \
	    echo ""; \
	    echo "An attempt to create two images with the same name. There is possibility"; \
	    echo "that you forgot to define IMAGE_SUFFIX or IMAGEFILE in one of the config files."; \
	    echo ""; \
	    echo "ERROR: Unable to overwrite the image $(IMAGEFILE)"; \
	    echo ""; \
	    exit 1; \
	fi >&2
	@$(TOOLSDIR)/show-install-info "$(WORKDIR)/initrd.img"
	@chmod 600 -- "$(WORKDIR)/initrd.img"
	@mv -f $(verbose) -- "$(WORKDIR)/initrd.img" "$(IMAGEFILE)"
	@echo "$(IMAGEFILE)" >> "$(TEMPDIR)/images"

genimage: install
	@$(MSG) "Image is saved as $(IMAGEFILE)"
	@echo

ALL_FEATURES         := $(call get-all-features)
ALL_DISABLE_FEATURES := $(call get-all-disable-features)
ALL_ACTIVE_FEATURES  := $(call get-all-active-features)

ifdef VERBOSE
$(info FEATURES              : $(sort $(FEATURES)))
$(info ALL FEATURES          : $(ALL_FEATURES))
$(info ALL DISABLED FEATURES : $(ALL_DISABLE_FEATURES))
$(info ALL ACTIVE FEATURES   : $(ALL_ACTIVE_FEATURES))
endif

# Load requested features
$(call include-features-once,$(sort $(ALL_ACTIVE_FEATURES)))
